<!doctype html>
<html>
<head>
<script id="bookmarklet_func">
var gs_netflix={

	version: '1.0',
	updated: '2016-01-06',

	get_movies: function(movies) {
		var movie_dicts = [];
		var last_day = undefined;
		var last_time = undefined;
		for (var i=0; i < movies.length; i++) {
			var dateStr = movies[i].querySelector('.date').textContent;
			/* what time?
			   if it's a weekday, default to 8pm
			   if it's a weekend default to 3pm, but add 1 hour for each successive use of the same day...
			*/
			var date = this.get_date(dateStr);
			var weekday = date.getDay();
			if (date == last_day) {
				last_time = last_time + 1;
			}
			else {
				if ((weekday == 0) || (weekday == 6)) {
					last_time = 15
				}
				else {
					last_time = 20
				}
				last_day = date;
			}
			date.setHours(last_time);
			/* sample: 2015-12-13T15:00 */
			dateStr = [date.getFullYear(), date.getMonth() + 1, date.getDate()].join('-') + 'T' + last_time + ':00'; 
			var title = movies[i].querySelector('.title a').textContent;
			var loc = window.location;
			var url = movies[i].querySelector('.title a').getAttribute('href');
			movie_dicts.push({
				'title': title,
				'pub_date': dateStr,
				'url': url
			});
		}
		return movie_dicts
	},

	get_date: function(str) {
		var bits = str.split('/');
		var date = new Date();
		date.setFullYear(bits[2]);
		date.setMonth(bits[1]-1);
		date.setDate(bits[0]);
		date.setHours(0);
		date.setMinutes(0);
		date.setSeconds(0);
		date.setMilliseconds(0);
		return date;
	},
	
	init: function(){
		var movies_html = document.getElementsByClassName('retableRow');
		data = this.get_movies(movies_html);
		var form_url = 'http://local.thisisglobal.com:8004/netflix/items/create/';
		var queryStr = '?data={"items":'+ JSON.stringify(data) + "}";
		var popup = window.open(form_url + queryStr, undefined, 'width=500,height=750,scrollbars,statusbar');
	}
};
</script>

</head>
<body>

<h1>Netflix Bookmarklet</h1>

<textarea id="output"></textarea>
<p>
	Drag this link to your bookmarks bar:<br />
	<a id="demo" href="#">Scrobble Netflix</a>
</p>

<h2>Sample Input</h2>
<ul class="retable">
	<li class="retableRow" data-series="" data-movieid="810117">
		<div class="col date nowrap">13/12/2015</div>
		<div class="col title"><a href="/WiMovie/810117?trkid=200250783">No Way Out</a></div>
		<div class="col report nowrap">
			<a class="reportLink status" href="WiMovie/810117">Report a problem</a>
		</div>
		<div class="col delete">
			<a class="deleteBtn" data-vh_index="" data-series="" href="#">×</a>
		</div>
	</li>
	<li class="retableRow" data-series="" data-movieid="70054715">
		<div class="col date nowrap">13/12/2015</div>
		<div class="col title">
			<a href="/WiMovie/70054715?trkid=200250783">The Conformist</a>
		</div>
		<div class="col report nowrap">
			<a class="reportLink status" href="WiMovie/70054715">Report a problem</a>
		</div>
		<div class="col delete">
			<a class="deleteBtn" data-vh_index="" data-series="" href="#">×</a>
		</div>
	</li>
	<li class="retableRow" data-series="80028382" data-movieid="80045895">
		<div class="col date nowrap">13/12/2015</div>
		<div class="col title">
			<a href="/WiMovie/80045895?trkid=200250783"><span class="seriestitle">Partners</span>: Season 1: "They Come Together"</a>
		</div>
		<div class="col report nowrap">
			<a class="reportLink status" href="WiMovie/80045895">Report a problem</a>
		</div>
		<div class="col delete">
			<a class="deleteBtn" data-vh_index="" data-series="80028382" href="#">×</a>
		</div>
	</li>
</ul>

<script>
var generate_bookmarklet = function() {
	var js = document.getElementById('bookmarklet_func').innerHTML;
	js = js.replace(/[\n\t]/g, '');
	var bookmarklet_js = 'javascript:' + js + 'gs_netflix.init();';
	document.getElementById('output').innerHTML = bookmarklet_js;
	document.getElementById('demo').setAttribute('href', bookmarklet_js);
}();

</script>
</body>
</html>